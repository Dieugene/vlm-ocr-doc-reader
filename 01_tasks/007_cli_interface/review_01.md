# Review отчет: CLI интерфейс для распознавания документов

## Общая оценка

**Статус:** Требует доработки

**Краткий вывод:** Основная функциональность CLI реализована корректно, но найдено две критические проблемы: отсутствует регистрация entry point в pyproject.toml и некорректное использование fixture в тестах (monkeybot вместо monkeypatch).

## Проверка соответствия ТЗ

**Технические критерии из analysis.md:**
- [x] TC-1: CLI принимает позиционный аргумент `pdf_path` - ✅ Выполнено (cli.py:102-105)
- [x] TC-2: CLI принимает опциональные флаги `--output-dir`, `--dpi`, `--log-level` - ✅ Выполнено (cli.py:107-127)
- [x] TC-3: CLI возвращает exit code 0 при успехе, 1 при ошибке - ✅ Выполнено (cli.py:196, 200, 204)
- [x] TC-4: CLI сохраняет результаты в `{output_dir}/results/full_description.yaml` - ✅ Выполнено (cli.py:175-182)
- [x] TC-5: CLI логирует прогресс в stdout (INFO уровень по умолчанию) - ✅ Выполнено (cli.py:24-35, 132)
- [ ] TC-6: CLI доступен глобально после `pip install -e .` - ❌ Критическая проблема (см. ниже)
- [ ] TC-7: Unit тесты мокают VLM вызовы и проверяют логику CLI - ⚠️ Частично (см. ниже)
- [x] TC-8: CLI обрабатывает ошибки (нет PDF, нет API ключа) - ✅ Выполнено (cli.py:38-65)

**Acceptance Criteria из task_brief:**
- [x] AC-1: CLI принимает путь к PDF как позиционный аргумент - ✅ Выполнено
- [x] AC-2: CLI принимает опциональный `--output-dir` для сохранения результатов - ✅ Выполнено
- [x] AC-3: CLI принимает опциональный `--dpi` для настройки качества рендеринга - ✅ Выполнено
- [x] AC-4: CLI использует `FullDescriptionOperation` под капотом - ✅ Выполнено (cli.py:171-172)
- [x] AC-5: CLI сохраняет результаты через существующий `DiskStorage` - ✅ Выполнено (cli.py:175-182)
- [x] AC-6: CLI показывает прогресс (логирование в stdout) - ✅ Выполнено
- [ ] AC-7: CLI зарегистрирован в `pyproject.toml` как `[project.scripts]` - ❌ Критическая проблема (см. ниже)
- [ ] AC-8: Unit тесты для CLI (мокованное выполнение, без реальных API вызовов) - ⚠️ Частично (см. ниже)

## Проблемы

### Проблема 1: Отсутствует регистрация CLI entry point в pyproject.toml

**Файл:** `pyproject.toml`

**Описание:** В pyproject.toml отсутствует секция `[project.scripts]` для регистрации команды `vlm-ocr-reader`. Согласно AC-7 и TC-6, CLI должен быть доступен глобально после `pip install -e .`. Без этой секции команда не будет зарегистрирована в системе.

**Серьезность:** Критическая

**Решение:** Добавить в pyproject.toml после строки 56:
```toml
[project.scripts]
vlm-ocr-reader = "vlm_ocr_doc_reader.cli:main"
```

**Ссылки на ТЗ:**
- task_brief_01.md:27 (AC-7)
- task_brief_01.md:62-68 (Регистрация в pyproject.toml)
- analysis_01.md:57 (Секция [project.scripts])
- analysis_01.md:176 (Пример конфигурации)

### Проблема 2: Некорректное имя fixture в тестах

**Файл:** `02_src/tests/unit/test_cli.py:134, 168, 185, 207, 256, 300, 339, 357`

**Описание:** В тестах используется `monkeybot` вместо корректного `monkeypatch` (стандартный fixture из pytest). Это вызывает ошибки при выполнении тестов: `fixture 'monkeybot' not found`. Все 8 тестов в классе TestMainFunction падают с этой ошибкой.

**Серьезность:** Высокая

**Решение:** Заменить все вхождения `monkeybot` на `monkeypatch` в параметрах функций.

**Пример:**
- Строка 134: `monkeybot` → `monkeypatch`
- Строка 138: `monkeybot.setenv` → `monkeypatch.setenv`
- И так далее для всех тестов в TestMainFunction

### Проблема 3: Некорректная проверка уровня логирования в тестах

**Файл:** `02_src/tests/unit/test_cli.py:47-52`

**Описание:** Тесты `test_setup_logging_debug` и `test_setup_logging_warning` некорректно проверяют уровень логирования. После вызова `setup_logging()`, логгер корня (root logger) имеет уровень WARNING вместо DEBUG/INFO из-за того, что pytest может настраивать логирование своим образом.

**Серьезность:** Низкая (тесты падают, но функциональность работает)

**Примечание:** Эта проблема вторичная по отношению к проблеме 2. После исправления проблемы 2, тесты все равно могут падать из-за этой проблемы.

## Положительные моменты

- **Чистая архитектура:** CLI правильно использует существующие модули (DocumentProcessor, FullDescriptionOperation) без дублирования логики
- **Хорошая валидация:** Проверка существования PDF файла и наличия API ключа до создания процессора (cli.py:38-65)
- **Корректная обработка ошибок:** Try-except блок с KeyboardInterrupt и общими исключениями (cli.py:198-204)
- **Информативное резюме:** Приятный вывод результатов с разделителями и статистикой (cli.py:186-194)
- **Правильное сохранение:** Использование state_manager для сохранения результатов (cli.py:175-182)
- **Хорошее покрытие тестами:** Тестируются различные сценарии (успех, ошибки, разные аргументы)

## Решение

**Действие:** Вернуть Analyst

**Обоснование:**

1. **Критическая проблема с entry point:** Отсутствие секции `[project.scripts]` в pyproject.toml означает, что AC-7 и TC-6 не выполнены. Это критическая функциональность, требуемая в ТЗ. Необходимо добавить эту секцию.

2. **Высокая проблема с тестами:** Некорректное использование fixture (`monkeybot` вместо `monkeypatch`) приводит к падению всех тестов в TestMainFunction. Это нарушает TC-7 и AC-8.

Эти проблемы требуют уточнения технического плана и исправления реализации. Хотя основная логика CLI реализована корректно, две критические проблемы блокируют приемку работы.

**Рекомендации для Analyst:**
- Обновить технический план с явным требованием добавить секцию `[project.scripts]` в pyproject.toml
- Добавить в технический план примечание о корректном использовании pytest fixtures (monkeypatch, не monkeybot)
- После исправления плана передать Developer для доработки
