# Review отчет: CLI интерфейс для распознавания документов (v2)

## Общая оценка

**Статус:** Требует доработки

**Краткий вывод:** Критическая проблема с entry point в pyproject.toml исправлена успешно, но проблема с pytest fixture решена частично - 2 из 8 тестовых функций все еще используют некорректное имя `monkeybot` вместо `monkeypatch`.

## Проверка соответствия ТЗ

**Технические критерии из analysis_02.md:**
- [x] TC-1: pyproject.toml содержит секцию `[project.scripts]` - ✅ Выполнено (pyproject.toml:58-59)
- [x] TC-2: Entry point зарегистрирован как `vlm-ocr-reader = "vlm_ocr_doc_reader.cli:main"` - ✅ Выполнено
- [ ] TC-3: После `pip install -e .` команда `vlm-ocr-reader --help` доступна - ⚠️ Проверка невозможна (требуется переустановка)
- [ ] TC-4: Все тестовые функции используют `monkeypatch` вместо `monkeybot` - ❌ Не выполнено (см. ниже)
- [ ] TC-5: Все тесты в test_cli.py проходят успешно - ❌ Не выполнено (из-за проблемы 2)
- [x] TC-6: CLI сохраняет результаты в `{output_dir}/results/full_description.yaml` - ✅ Выполнено (cli.py:175-182)
- [x] TC-7: CLI возвращает exit code 0 при успехе, 1 при ошибке - ✅ Выполнено (cli.py:196, 200, 204)

**Acceptance Criteria из task_brief_01.md:**
- [x] AC-1: CLI принимает путь к PDF как позиционный аргумент - ✅ Выполнено
- [x] AC-2: CLI принимает опциональный `--output-dir` для сохранения результатов - ✅ Выполнено
- [x] AC-3: CLI принимает опциональный `--dpi` для настройки качества рендеринга - ✅ Выполнено
- [x] AC-4: CLI использует `FullDescriptionOperation` под капотом - ✅ Выполнено (cli.py:171-172)
- [x] AC-5: CLI сохраняет результаты через существующий `DiskStorage` - ✅ Выполнено (cli.py:175-182)
- [x] AC-6: CLI показывает прогресс (логирование в stdout) - ✅ Выполнено
- [x] AC-7: CLI зарегистрирован в `pyproject.toml` как `[project.scripts]` - ✅ Выполнено
- [ ] AC-8: Unit тесты для CLI (мокованное выполнение, без реальных API вызовов) - ❌ Не выполнено (из-за проблемы 2)

## Проблемы

### Проблема 1: Не все тестовые функции исправлены

**Файл:** `02_src/tests/unit/test_cli.py:168, 185`

**Описание:** В тестах `test_main_pdf_not_found` (строка 168) и `test_main_missing_api_key` (строка 185) все еще используется параметр `monkeybot` вместо `monkeypatch`. Это вызывает ошибку `fixture 'monkeybot' not found` при выполнении этих тестов.

**Серьезность:** Высокая

**Детали:**
- Строка 168: `def test_main_pdf_not_found(self, mock_load_dotenv, monkeybot, tmp_path, capsys):` - параметр `monkeybot` вместо `monkeypatch`
- Строка 171: Внутри этой функции используется `monkeypatch.setenv()` - но параметр называется `monkeybot`, что вызовет `AttributeError: 'None' has no attribute 'setenv'`
- Строка 185: `def test_main_missing_api_key(self, mock_load_dotenv, mock_pdf_path, monkeybot, capsys):` - параметр `monkeybot` вместо `monkeypatch`
- Строка 188: Внутри этой функции используется `monkeypatch.delenv()` - но параметр называется `monkeybot`

**Решение:** Заменить `monkeybot` на `monkeypatch` в параметрах функций на строках 168 и 185.

### Проблема 2: Тесты уровня логирования (вторичная)

**Файл:** `02_src/tests/unit/test_cli.py:49-59`

**Описание:** Тесты `test_setup_logging_debug` и `test_setup_logging_warning` могут падать из-за того, что pytest переопределяет root logger. Эта проблема была отмечена в предыдущем review как вторичная и в analysis_02.md, но не устранена.

**Серьезность:** Низкая

**Примечание:** Эта проблема блокирует прохождение тестов, но не влияет на функциональность CLI.

## Положительные моменты

- **Entry point исправлен корректно:** Секция `[project.scripts]` добавлена в нужном месте (после строки 56), entry point зарегистрирован правильно как `vlm-ocr-reader = "vlm_ocr_doc_reader.cli:main"`
- **Большинство тестов исправлены:** 6 из 8 тестовых функций используют корректный `monkeypatch`
- **Сохранена корректная логика:** Все изменения касаются только исправления замечаний из review_01.md, основная логика CLI не нарушена

## Решение

**Действие:** Вернуть Analyst

**Обоснование:**

1. **Неполное исправление проблемы с fixture:** Из 8 тестовых функций класса TestMainFunction только 6 были исправлены. Функции `test_main_pdf_not_found` (строка 168) и `test_main_missing_api_key` (строка 185) все еще используют параметр `monkeybot` вместо `monkeypatch`, что приведет к падению тестов.

2. **Нарушение TC-4 и TC-5:** Технические критерии "Все тестовые функции используют monkeypatch вместо monkeybot" и "Все тесты в test_cli.py проходят успешно" не выполнены.

Эти проблемы требуют минимального исправления (замена 2 параметров в тестах), но блокируют приемку работы. Хотя критическая проблема с entry point решена успешно, неполное исправление тестов препятствует выполнению AC-8.

**Рекомендации для Analyst:**
- Обновить технический план с акцентом на необходимость замены `monkeybot` на `monkeypatch` во ВСЕХ тестовых функциях (а не только в большинстве)
- Добавить в технический план явный чеклист из 8 функций для проверки
- Рекомендовать Developer использовать поиск по файлу (`grep monkeybot test_cli.py`) для гарантированного поиска всех вхождений
