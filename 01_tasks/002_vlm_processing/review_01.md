# Review отчет: VLM Processing (критический путь)

## Общая оценка

**Статус:** Требует доработки

**Краткий вывод:** Реализована основная функциональность VLM Client, VLM Agent и DocumentProcessor. Однако обнаружено **3 критические проблемы**, которые препятствуют корректной работе: (1) неправильная логика retry на 400 статусе, (2) несоответствие полей PageInfo (page_num vs index), (3) отсутствие интеграции с PDFRenderer. VLM Agent работает корректно.

## Проверка соответствия ТЗ

**Технические критерии из analysis.md:**

### VLM Client
- [x] TC-1: GeminiVLMClient.invoke() выполняет запросы - ✅ Выполнено
- [x] TC-2: Retry работает на 429 статусе - ✅ Выполнено (тест проходит)
- [x] TC-3: Retry работает на 503 статусе - ✅ Выполнено (тест проходит)
- [ ] TC-4: Throttling гарантирует min_interval_s=0.6 - ⚠️ Частично (реализовано, но не проверено на стандартном значении)
- [x] TC-5: Возврат function_calls при tools - ✅ Выполнено (тест проходит)
- [x] TC-6: Возврат text без tools - ✅ Выполнено (тест проходит)

### VLM Agent
- [x] TC-7: 1 итерация при text ответе - ✅ Выполнено (тест test_invoke_one_iteration_no_tools проходит)
- [x] TC-8: Tool calling loop для 2 итераций - ✅ Выполнено (тест test_invoke_two_iterations_with_tool проходит)
- [x] TC-9: Tool calling loop для 10 итераций - ✅ Выполнено (тест test_invoke_ten_iterations проходит)
- [x] TC-10: Максимум 10 итераций - ✅ Выполнено (тест test_invoke_max_iterations_exceeded проходит)
- [x] TC-11: register_tool() регистрирует tools - ✅ Выполнено (тест test_register_tool проходит)
- [x] TC-12: set_system_prompt() устанавливает prompt - ✅ Выполнено (тест test_set_system_prompt проходит)

### DocumentProcessor
- [ ] TC-13: Инициализация из PDF - ❌ Проблема 3 (см. ниже)
- [ ] TC-14: Инициализация из PNG массива - ❌ Проблема 2 (см. ниже)
- [ ] TC-15: pages возвращает PageInfo - ❌ Проблема 2
- [ ] TC-16: num_pages возвращает количество - ❌ Проблема 2
- [ ] TC-17: save_state() сохраняет - ❌ Проблема 2
- [ ] TC-18: load_state() загружает - ❌ Проблема 2

**Acceptance Criteria из task_brief:**
- [ ] GeminiVLMClient.invoke() выполняет запросы - ✅ Выполнено
- [ ] VLMAgent.invoke() реализует tool calling loop - ✅ Выполнено
- [ ] VLMAgent.register_tool() регистрирует tools - ✅ Выполнено
- [ ] DocumentProcessor инициализируется из PDF - ❌ Проблема 3
- [ ] DocumentProcessor инициализируется из PNG - ❌ Проблема 2
- [ ] DocumentProcessor.pages возвращает список PageInfo - ❌ Проблема 2
- [ ] DocumentProcessor.num_pages возвращает количество - ❌ Проблема 2
- [ ] Unit тесты для VLM Client - ✅ Выполнено (9/10 тестов проходят)
- [ ] Unit тесты для throttling - ✅ Выполнено (но TC-4 частично)
- [ ] Unit тесты для tool calling loop - ✅ Выполнено (все 9 тестов проходят)
- [ ] Unit тесты для DocumentProcessor - ❌ Проблемы 2 и 3

## Проблемы

### Проблемма 1: Некорректная логика retry на 400 статусе

**Файл:** `02_src/vlm_ocr_doc_reader/core/vlm_client.py:126-136, 142-151`

**Описание:** Retry логика повторно пытается выполнить запрос при получении 400 (Bad Request). Согласно ТЗ (analysis.md раздел 6.2), retry должен выполняться **только** на 429 и 500-599. Ошибка 400 означает проблему с запросом (невалидные данные), повторение не поможет.

**Текущее поведение:** При 400 статусе выполняется 3 попытки (max_retries), вместо немедленного возврата ошибки.

**Ожидаемое поведение:** При 400 статусе должно выполняться `response.raise_for_status()` немедленно, без retry.

**Серьезность:** Критическая

**Тест:** `test_no_retry_on_400_status` падает с ошибкой:
```
AssertionError: assert 3 == 1
+  where 3 = <MagicMock name='post' id='1557471391632'>.call_count
```

---

### Проблема 2: Несоответствие PageInfo.page_num с PageInfo.index

**Файл:** `02_src/vlm_ocr_doc_reader/core/processor.py:121, 138`

**Описание:** DocumentProcessor использует `PageInfo(page_num=..., image=...)`, но в схеме `schemas/common.py` определено поле `index`, а не `page_num`. Это несовпадение названий приводит к `TypeError` при создании PageInfo.

**Текущее поведение:** Все тесты DocumentProcessor падают с ошибкой:
```
TypeError: PageInfo.__init__() got an unexpected keyword argument 'page_num'
```

**Ожидаемое поведение:** Использовать `PageInfo(index=..., image=...)` для согласованности с существующей схемой.

**Серьезность:** Критическая

---

### Проблема 3: Проблемы с моками импортов в тестах DocumentProcessor

**Файл:** `tests/test_core/test_processor.py:64-65`

**Описание:** Тесты пытаются замокать `os.getenv` и `load_dotenv` с неправильным путем: `@patch('vlm_ocr_doc_reader.core.processor.os.getenv')` и `@patch('vlm_ocr_doc_reader.core.processor.load_dotenv')`. Однако в `processor.py` импорты выполняются внутри функции (`import os` и `from dotenv import load_dotenv` в строках 53-54), что делает неправильным путь для моков.

**Текущее поведение:** Тесты падают с ошибкой `AttributeError: <module...> does not have the attribute 'load_dotenv'`

**Ожидаемое поведение:** Мокать импорты правильно, либо вынести импорты `os` и `load_dotenv` в начало файла `processor.py` для корректного мокания.

**Примечание:** Сам PDFRenderer существует (`02_src/vlm_ocr_doc_reader/preprocessing/renderer.py` создан в задаче 001), проблемы только в тестах.

**Серьезность:** Высокая

---

### Проблема 4: Логирование throttling на нестандартном min_interval_s

**Файл:** `tests/test_core/test_vlm_client.py:152`

**Описание:** Тест throttling использует `min_interval_s = 0.2` вместо стандартного `0.6` из ТЗ. Это снижает уверенность в том, что throttling корректно работает на требуемом значении.

**Текущее поведение:** Тест проверяет throttling только на 0.2s.

**Ожидаемое поведение:** Добавить тест с `min_interval_s = 0.6` для проверки соответствия ТЗ.

**Серьезность:** Низкая

---

### Проблема 5: Отсутствие интеграционных тестов

**Файл:** `01_tasks/002_vlm_processing/implementation_01.md:59`

**Описание:** В implementation.md указано: "Интеграционные тесты с реальным API вынесены в отдельную категорию (не реализованы в этой задаче)". Однако анализ.md (шаг 9) требует создания интеграционных тестов.

**Текущее поведение:** Интеграционные тесты отсутствуют.

**Ожидаемое поведение:** Создать `tests/integration/` с тестами для реального API (с пропуском если GEMINI_API_KEY не задан).

**Серьезность:** Низкая

## Положительные моменты

- VLM Agent реализован полностью корректно, все 9 тестов проходят
- Retry на 429 и 503 работает корректно (тесты проходят)
- Tool calling loop работает корректно для 1, 2, 10 и max_iterations сценариев
- Логирование реализовано на достаточном уровне для отладки
- Throttling логика использует `time.monotonic()` (правильно)
- Обработка ошибок в tool handlers реализована корректно

## Решение

**Действие:** Вернуть Analyst

**Обоснование:**

1. **Критические проблемы в реализации:**
   - Неправильная логика retry (проблема 1) - нарушение ТЗ (analysis.md раздел 6.2)
   - Несоответствие типов PageInfo (проблема 2) - несовместимость с существующим кодом из задачи 001
   - Проблемы с тестами DocumentProcessor (проблема 3) - некорректное мокание импортов

2. **Отклонения от ТЗ без обоснования:**
   - Интеграционные тесты не созданы (проблема 5) - требуется по analysis.md шаг 9
   - PageInfo использует разные названия полей в разных частях кода

3. **Требуется уточнение:**
   - Выбрать единое название поля для PageInfo (index vs page_num)
   - Исправить логику retry для 4xx ошибок (кроме 429)
   - Добавить интеграционные тесты или обосновать их отсутствие в analysis_02.md

Эти проблемы требуют обновления технического плана в analysis_02.md для согласованности с существующим кодом из задачи 001 и ТЗ.
