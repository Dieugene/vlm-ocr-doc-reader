# Backlog: vlm-ocr-doc-reader

**Версия:** 4.0
**Дата:** 2026-02-20
**Владелец:** Tech Lead

---

## Задачи

| ID | Название | Приоритет | Статус | Дата начала | Дата завершения | Зависимости |
|----|----------|-----------|--------|-------------|-----------------|-------------|
| 001 | Base utilities (PDF Renderer, OCR нормализация, State Manager) | High | Выполнена | 2026-01-27 | 2026-01-27 | Нет |
| 002 | VLM processing (VLM Client, VLM Agent, DocumentProcessor) | High | Выполнена | 2026-01-27 | 2026-01-27 | Задача 001 |
| 003 | OCR support (OCR Client, OCR Tool) | Medium | Выполнена | 2026-01-27 | 2026-01-27 | Задача 001 |
| 004 | High-level operations (FullDescriptionOperation) | High | Выполнена | 2026-01-27 | 2026-01-27 | Задача 002 |
| 005 | Критические баги (JSON mode, VLMAgent, OCR Tool) | Critical | Выполнена | 2026-01-27 | 2026-01-28 | Задачи 001-004 |
| 006 | pyproject.toml и подготовка к публикации | High | Выполнена | 2026-01-28 | 2026-01-28 | Нет |
| 007 | CLI интерфейс для распознавания документов | High | Выполнена | 2026-01-28 | 2026-01-28 | Нет |
| 008 | Рефакторинг и отладка (2026-02-09) | Critical | Выполнена | 2026-02-09 | 2026-02-09 | Задачи 001-007 |
| 009 | Оптимизация OCR: page-based batching (Variant 2) | High | Эскалация к Architect | - | - | Задача 008 |

---

## Фаза 1: v0.1.0 — Базовая реализация (ЗАВЕРШЕНА)

Задачи 001-007 — полный цикл от базовых утилит до CLI. Все задачи прошли review.

---

## Задача 008: Рефакторинг и отладка (2026-02-09)

**Статус:** Выполнена

**Что было сделано:**
- OCRTool теперь сам получает изображения из StateManager по page_num
- VLM Agent — единообразный вызов всех tool через `handler(**func_args)`
- VLM Client — поддержка `contents` (полная история диалога Gemini)
- Three-pass OCR стратегия: VLM читает → реестр OCR-сущностей → ask_ocr → подстановка
- Маркеры страниц [G{N}] в верхнем левом углу
- Параллельное выполнение tool calls (ThreadPoolExecutor, max_tool_workers=5)
- max_iterations увеличен до 100
- CLI: --max-tool-workers, --max-iterations
- Исправлена кодировка cp1251 (arrow char)
- Защита от None: `result.text or ''`

**Результаты тестовых запусков (test_document.pdf, 8 страниц):**

| Запуск | Время | OCR-вызовов | max_iter | Результат |
|--------|-------|-------------|----------|-----------|
| 174559 | 12 мин | 66 (sequential) | 100 | Полный текст + 48 headers |
| 191547 | 2 мин | 0 | 100 | Ошибка: text=None |
| 192010 | 7 мин | 10 | 10 | Неполный (text=null, 49 headers) |
| 193215 | 6 мин | 65 (parallel, 5 workers) | 100 | Полный текст + 58 headers |

---

## Задача 009: Оптимизация OCR — page-based batching (Variant 2)

**Статус:** Эскалация к Architect

**Проблема:** VLM запрашивает OCR для каждой сущности отдельно (66 ask_ocr вызовов). Многие нацелены на одну страницу (20+ URL с page 7, 21 с page 8). Это неоптимально: один Qwen-запрос занимает 5-10 сек, общее время OCR — 3-5 мин.

**Целевая метрика:** 66 вызовов → ~8 (один на страницу), время OCR: 5 мин → ~1 мин.

**Требует архитектурного решения:** см. `00_docs/architecture/_questions_architect.md`

---

## История изменений

| Дата | Версия | Изменения | Автор |
|------|--------|-----------|-------|
| 2026-02-20 | 4.0 | Актуализация: добавлена задача 008 (рефакторинг 2026-02-09), задача 009 (OCR batching), убран дубликат 007, обновлены даты | Tech Lead |
| 2026-01-28 | 3.0 | Добавлены задачи 006 (pyproject.toml) и 007 (CLI) | Tech Lead |
| 2026-01-27 | 2.0 | Переписан с укрупненными задачами (4 задачи вместо 37) | Tech Lead |
| 2026-01-27 | 1.0 | Первая версия (детализированный backlog) | Architect |
